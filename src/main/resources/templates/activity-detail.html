<!doctype html>
<html lang="ro" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <meta name="description" content="Detalii activitate JoinUs. Discuta in chat si vezi toate informatiile intr-un singur loc.">
        <meta name="author" content="">

        <title th:text="${activity.title + ' - JoinUs'}">Detalii activitate - JoinUs</title>

        <!-- CSS FILES -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,700;1,400&display=swap" rel="stylesheet">
        <link href="/css/bootstrap.min.css" rel="stylesheet">
        <link href="/css/bootstrap-icons.css" rel="stylesheet">
        <link href="/css/styles.css" rel="stylesheet">
    </head>

    <body class="page-activity-detail">
        <main>
            <div class="landing-theme">
                <header th:replace="~{fragments/navbar :: navbar}"></header>

                <div class="offcanvas offcanvas-end" data-bs-scroll="true" tabindex="-1" id="notificationsPanel" aria-labelledby="notificationsPanelLabel">
                    <div class="offcanvas-header">
                        <h5 class="offcanvas-title text-white" id="notificationsPanelLabel">Notificari</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
                    </div>

                    <div class="offcanvas-body d-flex flex-column">
                        <div class="notification-item">
                            <strong class="text-white">Alergare in parc</strong>
                            <p class="mb-1">Activitatea ta a fost aprobata si publicata.</p>
                            <small>Acum 5 minute</small>
                        </div>

                        <div class="notification-item">
                            <strong class="text-white">Yoga la apus</strong>
                            <p class="mb-1">S-au inscris inca 3 persoane.</p>
                            <small>Acum 24 de minute</small>
                        </div>

                        <div class="mt-auto">
                            <a href="#" class="btn custom-btn custom-border-btn w-100" data-bs-dismiss="offcanvas">Inchide</a>
                        </div>
                    </div>
                </div>

                <section class="hero-section d-flex justify-content-center align-items-center" id="section_home" style="background-image: none !important;">
                    <div class="section-overlay"></div>

                    <svg class="activity-detail-top-wave" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320">
                        <path fill="var(--secondary-color)" fill-opacity="1" d="M0,224 C240,160 480,288 720,224 C960,160 1200,288 1440,224 L1440,0 L0,0 Z"></path>
                    </svg>

                    <div class="container">
                        <div class="row">
                            <div class="col-12 hero-content">
                                <div class="activity-detail-hero-layout">
                                    <div class="activity-detail-hero-left">
                                        <h1 class="activity-detail-hero-title" th:text="${activity.title}">Titlu activitate</h1>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <svg class="hero-wave hero-wave-desktop" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320">
                        <path fill="var(--section-bg-color)" fill-opacity="1" d="M0,224 C240,160 480,288 720,224 C960,160 1200,288 1440,224 L1440,320 L0,320 Z"></path>
                    </svg>
                    <svg class="hero-wave hero-wave-mobile" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320" preserveAspectRatio="none">
                        <path fill="var(--section-bg-color)" fill-opacity="1" d="M0,224 C240,160 480,288 720,224 C960,160 1200,288 1440,224 L1440,320 L0,320 Z"></path>
                        <path fill="var(--section-bg-color)" fill-opacity="0.7" transform="translate(0,12)" d="M0,224 C240,160 480,288 720,224 C960,160 1200,288 1440,224 L1440,320 L0,320 Z"></path>
                        <path fill="var(--section-bg-color)" fill-opacity="0.4" transform="translate(0,24)" d="M0,224 C240,160 480,288 720,224 C960,160 1200,288 1440,224 L1440,320 L0,320 Z"></path>
                    </svg>
                </section>

                <section class="activity-detail-section section-bg">
                    <div class="activity-detail-container">
                    <div class="container">
                        <div class="activity-detail-grid">
                            <aside class="activity-sidebar">
                                <div class="activity-sidebar-card">
                                    <h5>Alte activitati</h5>
                                    <div class="activity-mini-list">
                                        <a class="activity-mini-card"
                                           th:each="item : ${otherActivities}"
                                           th:href="@{/activities/{id}(id=${item.id})}"
                                           th:classappend="${item.id == activity.id} ? ' is-active'">
                                            <img th:src="${item.imageUrl}" alt="Activitate" class="activity-mini-thumb">
                                            <div class="activity-mini-info">
                                                <h6 class="mb-1" th:text="${item.title}">Tur ciclist cu ghid</h6>
                                                <small th:text="${#temporals.format(item.date, 'dd MMM') + ', ' + #temporals.format(item.time, 'HH:mm')}">Astazi, 18:30</small>
                                            </div>
                                        </a>
                                    </div>
                                </div>

                                <section class="activity-participants-card" id="activityParticipantsCard" th:if="${isActivityCreator or canAccessChat}">
                                    <h5 class="mb-3">Participanti</h5>
                                    <div class="participants-container">
                                        <p class="text-muted mb-0" th:if="${#lists.isEmpty(approvedParticipationRequests) and (!isActivityCreator or #lists.isEmpty(pendingParticipationRequests))}">
                                            Nu exista participanti sau cereri in asteptare.
                                        </p>

                                        <div class="participation-request-card" th:if="${isActivityCreator}" th:each="request : ${pendingParticipationRequests}">
                                            <a class="participant-profile-link" th:href="@{/users/{id}(id=${request.user.id})}">
                                                <strong th:text="${request.user.fullName}">Nume utilizator</strong>
                                                <small class="d-block text-muted" th:text="${request.user.email}">email@example.com</small>
                                                <small class="d-block text-muted"
                                                       th:text="${#temporals.format(request.requestedAt, 'dd MMM yyyy, HH:mm')}">10 Feb 2026, 14:20</small>
                                            </a>
                                            <div class="participation-request-actions">
                                                <form method="post"
                                                      th:action="@{/activities/{id}/participation-requests/{requestId}/approve(id=${activity.id}, requestId=${request.id})}">
                                                    <button class="btn participation-action-btn is-accept" type="submit" title="Accepta">
                                                        <i class="bi bi-check-lg"></i>
                                                    </button>
                                                </form>
                                                <form method="post"
                                                      th:action="@{/activities/{id}/participation-requests/{requestId}/reject(id=${activity.id}, requestId=${request.id})}">
                                                    <button class="btn participation-action-btn is-reject" type="submit" title="Respinge">
                                                        <i class="bi bi-x-lg"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </div>

                                        <div class="participation-request-card is-approved" th:each="request : ${approvedParticipationRequests}">
                                            <a class="participant-profile-link" th:href="@{/users/{id}(id=${request.user.id})}">
                                                <strong th:text="${request.user.fullName}">Nume utilizator</strong>
                                                <small class="d-block text-muted" th:text="${request.user.email}">email@example.com</small>
                                            </a>
                                            <div class="dropdown" th:if="${isActivityCreator}">
                                                <button class="btn participation-menu-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Actiuni">
                                                    <i class="bi bi-list"></i>
                                                </button>
                                                <div class="dropdown-menu dropdown-menu-end participant-dropdown-menu">
                                                    <form method="post"
                                                          th:action="@{/activities/{id}/participation-requests/{requestId}/exclude(id=${activity.id}, requestId=${request.id})}">
                                                        <button class="dropdown-item text-danger" type="submit">Exclude participant</button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </section>
                            </aside>

                            <div class="activity-main-column">
                            <div class="activity-main-tools" th:if="${#authorization.expression('isAuthenticated()') and activity.creator != null and activity.creator.email == #authentication.name}">
                                <a class="btn custom-btn" th:href="@{/activities/{id}/edit(id=${activity.id})}">
                                    Editeaza activitatea
                                </a>
                            </div>
                            <section class="activity-chat" aria-live="polite">
                                <div class="activity-tabs" role="tablist">
                                    <button class="activity-tab-btn is-active" type="button" role="tab" aria-selected="true" aria-controls="activity-info-panel" data-tab="info">Info</button>
                                    <button class="activity-tab-btn" type="button" role="tab" aria-selected="false" aria-controls="activity-chat-panel" data-tab="chat" th:if="${canAccessChat}">Chat</button>
                                    <button class="activity-tab-btn" type="button" role="tab" aria-selected="false" aria-controls="activity-announcements-panel" data-tab="announcements" th:if="${canAccessChat}">Anunturi</button>
                                </div>

                                <div class="activity-tab-panel is-active" id="activity-info-panel" role="tabpanel" data-panel="info">
                                    <div class="alert mb-3"
                                         th:if="${participationMessage != null and !isActivityCreator}"
                                         th:classappend="${participationMessageType != null ? ' alert-' + participationMessageType : ' alert-info'}">
                                        <span th:text="${participationMessage}">Status participare</span>
                                    </div>

                                    <div class="mb-3"
                                         th:if="${#authorization.expression('isAuthenticated()') and !isActivityCreator and canRequestParticipation}">
                                        <form method="post"
                                              th:action="@{/activities/{id}/participation-request(id=${activity.id})}">
                                            <button class="btn custom-btn btn-sm" type="submit"
                                                    th:text="${participationStatus == T(com.scutelnic.joinus.entity.ParticipationStatus).REJECTED or participationStatus == T(com.scutelnic.joinus.entity.ParticipationStatus).EXCLUDED ? 'Trimite din nou cererea' : 'Cerere de participare'}">
                                                Cerere de participare
                                            </button>
                                        </form>
                                    </div>

                                    <div class="activity-info-section">
                                        <div class="activity-cover" th:style="'background-image: url(' + ${activity.imageUrl} + ');'">
                                            <span class="activity-capacity" th:text="${activity.capacity + ' locuri'}">12/20 locuri</span>
                                        </div>
                                        <h5 class="mb-3">Detalii rapide</h5>
                                        <div class="activity-meta activity-meta-card mb-3">
                                            <div class="activity-meta-item">
                                                <i class="bi bi-calendar-event"></i>
                                                <span th:text="${#temporals.format(activity.date, 'dd MMM yyyy')}">12 Feb 2026</span>
                                            </div>
                                            <div class="activity-meta-item">
                                                <i class="bi bi-clock"></i>
                                                <span th:text="${#temporals.format(activity.time, 'HH:mm')}">18:30</span>
                                            </div>
                                            <div class="activity-meta-item">
                                                <i class="bi bi-geo-alt"></i>
                                                <span th:text="${activity.location}">Piata Victoriei</span>
                                            </div>
                                            <div class="activity-meta-item">
                                                <i class="bi bi-people"></i>
                                                <span th:text="${activity.capacity + ' participanti'}">12 participanti</span>
                                            </div>
                                        </div>

                                        <p class="activity-quick-description" th:text="${activity.description}">
                                            Descriere activitate
                                        </p>
                                        <div class="activity-info-list">
                                            <div class="activity-info-item">
                                                <span>Adresa</span>
                                                <strong th:text="${activity.address}">Parcul Kiseleff</strong>
                                            </div>
                                            <div class="activity-info-item">
                                                <span>Categorie</span>
                                                <strong th:text="${activity.category}">Social</strong>
                                            </div>
                                            <div class="activity-info-item">
                                                <span>Taguri</span>
                                                <strong th:text="${activity.tags}">urban, foto</strong>
                                            </div>
                                            <div class="activity-info-item">
                                                <span>Creat la</span>
                                                <strong th:text="${#temporals.format(activity.createdAt, 'dd MMM yyyy, HH:mm')}">12 Feb 2026, 10:00</strong>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="activity-info-section" th:if="${activity.creator != null}">
                                        <div class="profile-header">
                                            <a class="creator-profile-link"
                                               th:href="@{/users/{id}(id=${activity.creator.id})}"
                                               th:title="${'Vezi profilul lui ' + activity.creator.fullName}">
                                                <img th:src="${activity.creator.avatarUrl != null and !#strings.isEmpty(activity.creator.avatarUrl) ? activity.creator.avatarUrl : '/images/members/portrait-young-handsome-businessman-wearing-suit-standing-with-crossed-arms-with-isolated-studio-white-background.jpg'}"
                                                     onerror="this.onerror=null;this.src='/images/members/portrait-young-handsome-businessman-wearing-suit-standing-with-crossed-arms-with-isolated-studio-white-background.jpg';"
                                                     alt="Profil organizator" class="profile-avatar">
                                            </a>
                                            <div>
                                                <h5 class="mb-1">
                                                    <a class="creator-profile-link creator-profile-link--name"
                                                       th:href="@{/users/{id}(id=${activity.creator.id})}"
                                                       th:text="${activity.creator.fullName}">Radu Ionescu</a>
                                                </h5>
                                                <p class="mb-0 profile-subtitle">Organizator</p>
                                            </div>
                                        </div>
                                        <p class="profile-description" th:text="${activity.creator.bio}">Iubesc activitatile in aer liber si imi place sa aduc oamenii impreuna.</p>
                                        <div class="profile-info-list">
                                            <div class="profile-info-item" th:if="${activity.creator.birthDate != null}">
                                                <span>Varsta</span>
                                                <strong th:text="${T(java.time.Period).between(activity.creator.birthDate, T(java.time.LocalDate).now()).getYears() + ' ani'}">29 ani</strong>
                                            </div>
                                            <div class="profile-info-item">
                                                <span>Email</span>
                                                <strong th:text="${activity.creator.email}">radu@joinus.ro</strong>
                                            </div>
                                        </div>
                                    </div>

                                </div>

                                <div class="activity-tab-panel" id="activity-chat-panel" role="tabpanel" data-panel="chat" th:if="${canAccessChat}">
                                    <div class="chat-stream" id="chatStream"></div>

                                    <div class="chat-input">
                                        <input class="form-control" id="chatInput" type="text" placeholder="Scrie un mesaj..." th:disabled="${#authorization.expression('isAnonymous()')}">
                                        <button class="btn custom-btn" id="chatSendBtn" type="button" th:disabled="${#authorization.expression('isAnonymous()')}"><i class="bi bi-send"></i> Trimite</button>
                                    </div>
                                    <small class="text-muted mt-2" th:if="${#authorization.expression('isAnonymous()')}">Autentifica-te ca sa participi la chat.</small>
                                </div>

                                <div class="activity-tab-panel" id="activity-announcements-panel" role="tabpanel" data-panel="announcements" th:if="${canAccessChat}">
                                    <div class="announcement-list">
                                        <div class="announcement-card">
                                            <strong>Organizator</strong>
                                            <p class="mb-2">Avem nevoie de 2 voluntari pentru a ghida grupul din spate.</p>
                                            <small>Actualizat astazi, 17:40</small>
                                        </div>
                                        <div class="announcement-card">
                                            <strong>Update traseu</strong>
                                            <p class="mb-2">Vom opri la Podul Muncii pentru o poza de grup.</p>
                                            <small>Actualizat ieri</small>
                                        </div>
                                        <div class="announcement-card">
                                            <strong>Memento</strong>
                                            <p class="mb-2">Nu uitati sa aveti lumini la bicicleta si apa.</p>
                                            <small>Acum 2 zile</small>
                                        </div>
                                    </div>
                                </div>
                            </section>

                            </div>

                        </div>
                    </div>
                    </div>
                </section>
            </div>
        </main>

        <footer th:replace="~{fragments/footer :: footer}"></footer>

        <!-- JAVASCRIPT FILES -->
        <script src="/js/jquery.min.js"></script>
        <script src="/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7/bundles/stomp.umd.min.js"></script>
        <script src="/js/jquery.sticky.js"></script>
        <script src="/js/custom.js"></script>
        <script th:inline="javascript">
            const tabButtons = document.querySelectorAll('.activity-tab-btn');
            const tabPanels = document.querySelectorAll('.activity-tab-panel');

            tabButtons.forEach((button) => {
                button.addEventListener('click', () => {
                    const target = button.dataset.tab;

                    tabButtons.forEach((btn) => {
                        const isActive = btn === button;
                        btn.classList.toggle('is-active', isActive);
                        btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
                    });

                    tabPanels.forEach((panel) => {
                        panel.classList.toggle('is-active', panel.dataset.panel === target);
                    });

                    if (target === 'chat') {
                        setTimeout(scrollChatToBottom, 0);
                    }
                    syncChatPanelHeight();
                });
            });

            const activityId = Number(/*[[${activity.id}]]*/ 0);
            const currentUserId = /*[[${currentUserId}]]*/ null;
            const isAuthenticated = /*[[${#authorization.expression('isAuthenticated()')}]]*/ false;
            const canAccessChat = /*[[${canAccessChat}]]*/ false;
            const chatStreamEl = document.getElementById('chatStream');
            const chatInputEl = document.getElementById('chatInput');
            const chatSendBtnEl = document.getElementById('chatSendBtn');
            const activityChatEl = document.querySelector('.activity-chat');

            const messageElements = new Map();
            const messageState = new Map();
            let stompClient = null;
            let seenObserver = null;
            const REACTION_OPTIONS = [
                { type: 'LIKE', emoji: 'ðŸ‘' },
                { type: 'LOVE', emoji: 'â¤ï¸' },
                { type: 'LAUGH', emoji: 'ðŸ˜‚' },
                { type: 'WOW', emoji: 'ðŸ˜®' }
            ];

            function formatTime(isoDate) {
                const date = new Date(isoDate);
                return date.toLocaleTimeString('ro-RO', { hour: '2-digit', minute: '2-digit' });
            }

            function isOwnMessageState(state) {
                return state && currentUserId !== null && Number(state.senderId) === Number(currentUserId);
            }

            function buildStatusValue(state) {
                if (!isOwnMessageState(state)) {
                    return { text: '', className: '' };
                }
                if (state.seenCount > 0) {
                    return { text: 'âœ“âœ“', className: 'is-seen' };
                }
                if (state.deliveredCount > 0) {
                    return { text: 'âœ“âœ“', className: 'is-delivered' };
                }
                return { text: 'âœ“', className: 'is-sent' };
            }

            function updateBubbleStatus(messageId) {
                const bubble = messageElements.get(messageId);
                const state = messageState.get(messageId);
                if (!bubble || !state) return;
                const statusEl = bubble.querySelector('.chat-status');
                if (!statusEl) return;

                const status = buildStatusValue(state);
                statusEl.textContent = status.text;
                statusEl.className = `chat-status ${status.className}`.trim();
            }

            function buildReactionState(message) {
                const reactionsByType = {};
                REACTION_OPTIONS.forEach(({ type }) => {
                    reactionsByType[type] = 0;
                });

                if (Array.isArray(message.reactions)) {
                    message.reactions.forEach((reaction) => {
                        if (!reaction || !reaction.reactionType) return;
                        reactionsByType[reaction.reactionType] = Number(reaction.count || 0);
                    });
                }

                return {
                    reactionsByType,
                    currentUserReactionType: message.currentUserReactionType || null
                };
            }

            function renderReactionSummary(messageId) {
                const bubble = messageElements.get(messageId);
                const state = messageState.get(messageId);
                if (!bubble || !state) return;

                const summaryEl = bubble.querySelector('.chat-reaction-summary');
                if (!summaryEl) return;
                summaryEl.innerHTML = '';

                REACTION_OPTIONS.forEach(({ type, emoji }) => {
                    const count = Number(state.reactionsByType?.[type] || 0);
                    if (count <= 0) return;

                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'chat-reaction-pill';
                    if (state.currentUserReactionType === type) {
                        button.classList.add('is-active');
                    }
                    button.dataset.messageId = String(messageId);
                    button.dataset.reactionType = type;
                    button.innerHTML = `<span>${emoji}</span><small>${count}</small>`;
                    summaryEl.appendChild(button);
                });

                const totalReactions = REACTION_OPTIONS.reduce((sum, option) => {
                    return sum + Number(state.reactionsByType?.[option.type] || 0);
                }, 0);
                bubble.classList.toggle('has-reactions', totalReactions > 0);
            }

            function renderReactionPicker(messageId) {
                const bubble = messageElements.get(messageId);
                const state = messageState.get(messageId);
                if (!bubble || !state) return;

                const pickerEl = bubble.querySelector('.chat-reaction-picker');
                if (!pickerEl) return;
                pickerEl.innerHTML = '';

                REACTION_OPTIONS.forEach(({ type, emoji }) => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'chat-reaction-btn';
                    if (state.currentUserReactionType === type) {
                        button.classList.add('is-active');
                    }
                    button.dataset.messageId = String(messageId);
                    button.dataset.reactionType = type;
                    button.textContent = emoji;
                    pickerEl.appendChild(button);
                });
            }

            function updateBubbleReactions(messageId) {
                renderReactionSummary(messageId);
                renderReactionPicker(messageId);
            }

            function getLastRenderedBubble() {
                if (!chatStreamEl) return null;
                let node = chatStreamEl.lastElementChild;
                while (node && !node.classList.contains('chat-bubble')) {
                    node = node.previousElementSibling;
                }
                return node;
            }

            function shouldRenderSenderLabel(message) {
                const previousBubble = getLastRenderedBubble();
                if (!previousBubble) {
                    return true;
                }
                return Number(previousBubble.dataset.senderId) !== Number(message.senderId);
            }

            function renderMessage(message) {
                if (messageElements.has(message.id)) {
                    return;
                }

                const showSenderLabel = shouldRenderSenderLabel(message);
                const isOwnMessage = currentUserId !== null && Number(message.senderId) === Number(currentUserId);

                if (showSenderLabel) {
                    const senderLabel = document.createElement('div');
                    senderLabel.className = 'chat-sender-label';
                    if (isOwnMessage) {
                        senderLabel.classList.add('me');
                    }
                    senderLabel.textContent = message.senderName;
                    chatStreamEl.appendChild(senderLabel);
                }

                const bubble = document.createElement('div');
                bubble.className = 'chat-bubble';
                if (isOwnMessage) {
                    bubble.classList.add('me');
                }
                bubble.dataset.messageId = String(message.id);
                bubble.dataset.createdAt = message.createdAt;
                bubble.dataset.senderId = String(message.senderId);

                const content = document.createElement('p');
                content.className = 'mb-0';
                content.textContent = message.content;

                const footer = document.createElement('div');
                footer.className = 'chat-footer';

                const time = document.createElement('span');
                time.className = 'chat-time';
                time.textContent = formatTime(message.createdAt);

                const status = document.createElement('span');
                status.className = 'chat-status';
                footer.appendChild(status);

                const header = document.createElement('div');
                header.className = 'chat-header';
                header.appendChild(time);

                const reactionRow = document.createElement('div');
                reactionRow.className = 'chat-reaction-row';

                const reactionSummary = document.createElement('div');
                reactionSummary.className = 'chat-reaction-summary';

                const reactionPicker = document.createElement('div');
                reactionPicker.className = 'chat-reaction-picker';

                reactionRow.appendChild(reactionSummary);
                reactionRow.appendChild(reactionPicker);

                bubble.appendChild(header);
                bubble.appendChild(content);
                bubble.appendChild(footer);
                bubble.appendChild(reactionRow);

                chatStreamEl.appendChild(bubble);
                messageElements.set(message.id, bubble);

                const reactionState = buildReactionState(message);
                messageState.set(message.id, {
                    senderId: message.senderId,
                    deliveredCount: message.deliveredCount || 0,
                    seenCount: message.seenCount,
                    reactionsByType: reactionState.reactionsByType,
                    currentUserReactionType: reactionState.currentUserReactionType
                });
                updateBubbleStatus(message.id);
                updateBubbleReactions(message.id);

                const state = messageState.get(message.id);
                if (seenObserver && state && !isOwnMessageState(state)) {
                    seenObserver.observe(bubble);
                }
            }

            function updateMessageStatus(messageId, deliveredCount, seenCount) {
                const bubble = messageElements.get(messageId);
                if (!bubble) return;
                const state = messageState.get(messageId);
                if (!state) return;
                state.deliveredCount = deliveredCount;
                state.seenCount = seenCount;
                messageState.set(messageId, state);
                updateBubbleStatus(messageId);
            }

            function updateMessageReactions(messageId, reactions, actorUserId, actorReactionType) {
                const bubble = messageElements.get(messageId);
                if (!bubble) return;
                const state = messageState.get(messageId);
                if (!state) return;

                const nextReactions = { ...(state.reactionsByType || {}) };
                REACTION_OPTIONS.forEach(({ type }) => {
                    nextReactions[type] = 0;
                });

                if (Array.isArray(reactions)) {
                    reactions.forEach((reaction) => {
                        if (!reaction || !reaction.reactionType) return;
                        nextReactions[reaction.reactionType] = Number(reaction.count || 0);
                    });
                }

                state.reactionsByType = nextReactions;

                if (currentUserId !== null && Number(actorUserId) === Number(currentUserId)) {
                    state.currentUserReactionType = actorReactionType || null;
                }

                messageState.set(messageId, state);
                updateBubbleReactions(messageId);
            }

            function publishReaction(messageId, reactionType) {
                if (!stompClient || !stompClient.connected) return;
                if (!messageId || !reactionType) return;
                stompClient.publish({
                    destination: `/app/activities/${activityId}/reactions`,
                    body: JSON.stringify({ messageId: Number(messageId), reactionType })
                });
            }

            function wireReactionClicks() {
                if (!chatStreamEl) return;
                chatStreamEl.addEventListener('click', (event) => {
                    const target = event.target.closest('[data-reaction-type][data-message-id]');
                    if (!target) return;
                    const messageId = Number(target.dataset.messageId);
                    const reactionType = target.dataset.reactionType;
                    if (!messageId || !reactionType) return;
                    publishReaction(messageId, reactionType);
                });
            }

            function scrollChatToBottom() {
                chatStreamEl.scrollTop = chatStreamEl.scrollHeight;
            }

            function syncChatPanelHeight() {
                if (!activityChatEl) return;
                if (window.innerWidth <= 991) {
                    activityChatEl.style.height = '';
                    return;
                }

                const activePanel = document.querySelector('.activity-tab-panel.is-active');
                if (!activePanel || activePanel.dataset.panel !== 'chat') {
                    activityChatEl.style.height = '';
                    return;
                }

                const navbarEl = document.querySelector('.navbar');
                const navbarHeight = navbarEl ? navbarEl.offsetHeight : 0;
                const viewportTarget = window.innerHeight - navbarHeight - 110;
                const targetHeight = Math.max(620, Math.min(900, viewportTarget));
                activityChatEl.style.height = `${targetHeight}px`;
            }

            function publishSeenForVisibleMessages() {
                if (!stompClient || !stompClient.connected || !chatStreamEl) return;
                const streamRect = chatStreamEl.getBoundingClientRect();
                messageElements.forEach((bubble) => {
                    if (bubble.dataset.seenPublished === '1') return;
                    if (currentUserId !== null && Number(bubble.dataset.senderId) === Number(currentUserId)) {
                        bubble.dataset.seenPublished = '1';
                        return;
                    }
                    const bubbleRect = bubble.getBoundingClientRect();
                    const visibleTop = Math.max(streamRect.top, bubbleRect.top);
                    const visibleBottom = Math.min(streamRect.bottom, bubbleRect.bottom);
                    const visibleHeight = Math.max(0, visibleBottom - visibleTop);
                    const ratio = visibleHeight / Math.max(1, bubbleRect.height);
                    if (ratio < 0.9) return;

                    stompClient.publish({
                        destination: `/app/activities/${activityId}/seen`,
                        body: JSON.stringify({ messageId: Number(bubble.dataset.messageId) })
                    });
                    bubble.dataset.seenPublished = '1';
                });
            }

            function publishDeliveredForRenderedMessages() {
                if (!stompClient || !stompClient.connected) return;
                messageElements.forEach((bubble, messageId) => {
                    if (bubble.dataset.deliveryPublished === '1') return;
                    if (currentUserId !== null && Number(bubble.dataset.senderId) === Number(currentUserId)) {
                        bubble.dataset.deliveryPublished = '1';
                        return;
                    }
                    stompClient.publish({
                        destination: `/app/activities/${activityId}/delivered`,
                        body: JSON.stringify({ messageId: Number(messageId) })
                    });
                    bubble.dataset.deliveryPublished = '1';
                });
            }

            async function loadInitialMessages() {
                const response = await fetch(`/api/activities/${activityId}/messages?limit=60`, { credentials: 'same-origin' });
                if (!response.ok) {
                    return [];
                }
                const messages = await response.json();
                messages.forEach(renderMessage);
                scrollChatToBottom();
                return messages;
            }

            function setupSeenObserver() {
                if (!chatStreamEl || !window.IntersectionObserver) {
                    return;
                }
                seenObserver = new IntersectionObserver((entries) => {
                    entries.forEach((entry) => {
                        if (!entry.isIntersecting) return;
                        const bubble = entry.target;
                        if (bubble.dataset.seenPublished === '1') {
                            seenObserver.unobserve(bubble);
                            return;
                        }
                        if (!stompClient || !stompClient.connected) return;
                        if (currentUserId !== null && Number(bubble.dataset.senderId) === Number(currentUserId)) {
                            bubble.dataset.seenPublished = '1';
                            seenObserver.unobserve(bubble);
                            return;
                        }
                        stompClient.publish({
                            destination: `/app/activities/${activityId}/seen`,
                            body: JSON.stringify({ messageId: Number(bubble.dataset.messageId) })
                        });
                        bubble.dataset.seenPublished = '1';
                        seenObserver.unobserve(bubble);
                    });
                }, {
                    root: chatStreamEl,
                    threshold: 0.9
                });

                messageElements.forEach((bubble) => {
                    if (bubble.dataset.seenPublished === '1') return;
                    if (currentUserId !== null && Number(bubble.dataset.senderId) === Number(currentUserId)) return;
                    seenObserver.observe(bubble);
                });
            }

            function connectChatSocket() {
                stompClient = new StompJs.Client({
                    webSocketFactory: () => new SockJS('/ws'),
                    reconnectDelay: 5000
                });

                stompClient.onConnect = () => {
                    stompClient.subscribe(`/topic/activities/${activityId}`, (frame) => {
                        const message = JSON.parse(frame.body);
                        renderMessage(message);
                        scrollChatToBottom();
                        publishDeliveredForRenderedMessages();
                        publishSeenForVisibleMessages();
                    });

                    stompClient.subscribe(`/topic/activities/${activityId}/status`, (frame) => {
                        const event = JSON.parse(frame.body);
                        updateMessageStatus(event.messageId, event.deliveredCount || 0, event.seenCount || 0);
                    });

                    stompClient.subscribe(`/topic/activities/${activityId}/reactions`, (frame) => {
                        const event = JSON.parse(frame.body);
                        updateMessageReactions(
                                event.messageId,
                                event.reactions || [],
                                event.actorUserId,
                                event.actorReactionType
                        );
                    });

                    publishDeliveredForRenderedMessages();
                    publishSeenForVisibleMessages();
                };

                stompClient.activate();
            }

            function wireSendMessage() {
                if (!chatInputEl || !chatSendBtnEl) return;

                const send = () => {
                    if (!stompClient || !stompClient.connected) return;
                    const content = chatInputEl.value.trim();
                    if (!content) return;
                    stompClient.publish({
                        destination: `/app/activities/${activityId}/chat`,
                        body: JSON.stringify({ content })
                    });
                    chatInputEl.value = '';
                };

                chatSendBtnEl.addEventListener('click', send);
                chatInputEl.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        send();
                    }
                });
            }

            if (isAuthenticated && canAccessChat && activityId > 0) {
                loadInitialMessages()
                        .then(() => {
                            setupSeenObserver();
                            connectChatSocket();
                            wireSendMessage();
                            wireReactionClicks();
                            syncChatPanelHeight();
                        })
                        .catch(() => {
                            // Ignore initial load failures.
                        });
            } else {
                syncChatPanelHeight();
            }

            window.addEventListener('resize', syncChatPanelHeight);
            window.addEventListener('load', syncChatPanelHeight);
            if (chatStreamEl) {
                chatStreamEl.addEventListener('scroll', publishSeenForVisibleMessages);
            }

            setTimeout(() => {
                syncChatPanelHeight();
            }, 0);
        </script>
    </body>
</html>
