<!doctype html>
<html lang="ro" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Editeaza profilul JoinUs">
    <title>Editeaza profilul</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,700;1,400&display=swap" rel="stylesheet">
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/styles.css" rel="stylesheet">
</head>
<body class="page-profile page-profile-modern page-profile-edit">
<main th:with="displayUser=${profileUser},
               displayAvatar=${profileAvatarUrl}">
    <div class="landing-theme profile-theme">
        <header th:replace="~{fragments/navbar :: navbar}"></header>

        <div class="offcanvas offcanvas-end" data-bs-scroll="true" tabindex="-1" id="notificationsPanel" aria-labelledby="notificationsPanelLabel">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title text-white" id="notificationsPanelLabel">Notificari</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body d-flex flex-column">
                <div class="notification-item">
                    <strong class="text-white">Profil</strong>
                    <p class="mb-1">Editezi datele contului tau.</p>
                    <small>Acum</small>
                </div>
                <div class="mt-auto">
                    <a href="#" class="btn custom-btn custom-border-btn w-100" data-bs-dismiss="offcanvas">Inchide</a>
                </div>
            </div>
        </div>

        <section class="profile-hero-cover" id="section_profile_edit_hero">
            <div class="container">
                <div class="row">
                    <div class="col-lg-8 col-12 mx-auto text-center hero-content">
                        <h2 class="text-white">Editeaza profilul</h2>
                        <h1 class="text-white mb-0" th:text="${displayUser.fullName}">Nume utilizator</h1>
                    </div>
                </div>
            </div>

            <svg class="profile-hero-wave profile-hero-wave-bottom" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 220" preserveAspectRatio="none">
                <path fill="var(--section-bg-color)" d="M0,88 C180,20 340,28 522,86 C698,140 862,144 1044,90 C1198,42 1322,36 1440,78 L1440,220 L0,220 Z"></path>
            </svg>
        </section>
    </div>

    <div class="profile-container">
        <div class="profile-edit-layout">
            <aside class="profile-edit-preview-card">
                <div class="profile-edit-avatar-shell" th:classappend="${displayAvatar == null} ? ' is-fallback' : ''">
                    <img th:if="${displayAvatar != null}"
                         th:src="${displayAvatar}"
                         alt="Avatar utilizator"
                         class="profile-edit-avatar"
                         onerror="this.closest('.profile-edit-avatar-shell').classList.add('is-fallback'); this.remove();">
                    <i class="bi bi-person-circle profile-edit-avatar-icon" aria-hidden="true"></i>
                </div>
                <h3 class="mb-1" th:text="${displayUser.fullName}">Nume utilizator</h3>
                <p class="profile-edit-muted mb-3" th:text="${displayUser.email}">email@example.com</p>
                <div class="profile-edit-divider"></div>
                <div class="profile-edit-inline" th:if="${displayUser.birthDate != null}">
                    <span>Data nasterii</span>
                    <strong th:text="${#temporals.format(displayUser.birthDate, 'dd MMM yyyy')}">13 Feb 2003</strong>
                </div>
                <div class="profile-edit-inline" th:if="${displayUser.birthDate == null}">
                    <span>Data nasterii</span>
                    <strong>Nu este completata</strong>
                </div>
            </aside>

            <section class="profile-edit-form-card">
                <h3 class="mb-2">Date profil</h3>
                <p class="profile-edit-muted mb-4">Actualizeaza informatiile contului tau. Modificarile se salveaza imediat dupa submit.</p>

                <div class="alert alert-success" th:if="${param.updated}">
                    Profilul a fost actualizat cu succes.
                </div>
                <div class="alert alert-danger" th:if="${param.error}">
                    Nu am putut salva modificarile. Verifica datele si incearca din nou.
                </div>
                <div class="alert alert-danger" th:if="${birthDateRequired}">
                    Data nasterii este obligatorie pentru a continua.
                </div>
                <div class="alert alert-danger" th:if="${profileImageError}" th:text="${profileImageError}">
                    Nu am putut incarca avatarul.
                </div>

                <form class="profile-edit-form"
                      th:action="@{/profile}"
                      th:object="${profileForm}"
                      method="post"
                      enctype="multipart/form-data"
                      role="form">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                    <input type="hidden" th:field="*{avatarUrl}">
                    <input type="hidden"
                           id="birthDateHidden"
                           name="birthDate"
                           th:value="${profileForm.birthDate != null ? #temporals.format(profileForm.birthDate, 'yyyy-MM-dd') : (displayUser.birthDate != null ? #temporals.format(displayUser.birthDate, 'yyyy-MM-dd') : '')}">
                    <input type="hidden" name="requireBirthDate" th:value="${birthDateRequired}">

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label" for="fullName">Nume complet</label>
                            <input id="fullName"
                                   type="text"
                                   class="form-control"
                                   th:field="*{fullName}"
                                   maxlength="120"
                                   required>
                            <small class="text-danger" th:if="${#fields.hasErrors('fullName')}" th:errors="*{fullName}"></small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="emailReadonly">Email</label>
                            <input id="emailReadonly" type="email" class="form-control" th:value="${displayUser.email}" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Data nasterii</label>
                            <div class="birthdate-manual-grid">
                                <select id="birthDay" class="form-control" th:attr="required=${birthDateRequired}">
                                    <option value="">Zi</option>
                                    <option th:each="d : ${#numbers.sequence(1,31)}" th:value="${d}" th:text="${d}"></option>
                                </select>
                                <select id="birthMonth" class="form-control" th:attr="required=${birthDateRequired}">
                                    <option value="">Luna</option>
                                    <option th:each="m : ${#numbers.sequence(1,12)}" th:value="${m}" th:text="${m}"></option>
                                </select>
                                <select id="birthYear" class="form-control" th:attr="required=${birthDateRequired}">
                                    <option value="">An</option>
                                    <option th:each="y : ${#numbers.sequence(1900, currentYear)}" th:value="${y}" th:text="${y}"></option>
                                </select>
                            </div>
                            <div class="birthdate-manual-hints">
                                <small class="profile-edit-muted">Ziua</small>
                                <small class="profile-edit-muted">Luna</small>
                                <small class="profile-edit-muted">Anul</small>
                            </div>
                            <small class="text-danger" th:if="${#fields.hasErrors('birthDate')}" th:errors="*{birthDate}"></small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="imageFile">Incarca avatar nou</label>
                            <input id="imageFile" type="file" name="imageFile" accept="image/*" class="form-control">
                            <small class="profile-edit-muted">Imaginea va fi urcata in Cloudinary.</small>
                        </div>
                        <div class="col-12">
                            <label class="form-label" for="bio">Descriere</label>
                            <textarea id="bio"
                                      class="form-control"
                                      th:field="*{bio}"
                                      rows="5"
                                      maxlength="300"
                                      placeholder="Spune cateva cuvinte despre tine..."></textarea>
                            <small class="text-danger" th:if="${#fields.hasErrors('bio')}" th:errors="*{bio}"></small>
                        </div>
                    </div>

                    <div class="profile-edit-actions">
                        <a class="btn custom-btn custom-border-btn" th:href="@{/profile}">Inapoi la profil</a>
                        <button type="submit" class="btn custom-btn">Salveaza modificarile</button>
                    </div>
                </form>
            </section>
        </div>
    </div>
</main>

<footer th:replace="~{fragments/footer :: footer}"></footer>

<script src="/js/jquery.min.js"></script>
<script src="/js/bootstrap.bundle.min.js"></script>
<script src="/js/jquery.sticky.js"></script>
<script src="/js/click-scroll.js"></script>
<script src="/js/animated-headline.js"></script>
<script src="/js/modernizr.js"></script>
<script src="/js/custom.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('.profile-edit-form');
        const hiddenBirthDate = document.getElementById('birthDateHidden');
        const dayInput = document.getElementById('birthDay');
        const monthInput = document.getElementById('birthMonth');
        const yearInput = document.getElementById('birthYear');
        const currentYear = new Date().getFullYear();

        const padTwo = (value) => String(value).padStart(2, '0');

        function readPart(input, min, max) {
            if (!input) {
                return null;
            }
            if (!input.value) {
                return null;
            }
            let number = parseInt(input.value, 10);
            if (Number.isNaN(number)) {
                return null;
            }
            if (number < min || number > max) {
                return null;
            }
            return number;
        }

        function isValidDate(year, month, day) {
            const date = new Date(year, month - 1, day);
            return date.getFullYear() === year
                && date.getMonth() === month - 1
                && date.getDate() === day;
        }

        function syncHiddenBirthDate() {
            const day = readPart(dayInput, 1, 31);
            const month = readPart(monthInput, 1, 12);
            const year = readPart(yearInput, 1900, currentYear);

            if (day && month && year && isValidDate(year, month, day)) {
                hiddenBirthDate.value = `${year}-${padTwo(month)}-${padTwo(day)}`;
                return;
            }
            hiddenBirthDate.value = '';
        }

        function prefillFromHidden() {
            const value = hiddenBirthDate ? hiddenBirthDate.value : '';
            if (!value) {
                return;
            }
            const parts = value.split('-');
            if (parts.length !== 3) {
                return;
            }
            const year = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10);
            const day = parseInt(parts[2], 10);
            if (!Number.isNaN(day)) {
                dayInput.value = String(day);
            }
            if (!Number.isNaN(month)) {
                monthInput.value = String(month);
            }
            if (!Number.isNaN(year)) {
                yearInput.value = String(year);
            }
        }

        [dayInput, monthInput, yearInput].forEach((input) => {
            if (!input) {
                return;
            }
            input.addEventListener('change', syncHiddenBirthDate);
        });

        if (form) {
            form.addEventListener('submit', syncHiddenBirthDate);
        }

        prefillFromHidden();
    });
</script>
</body>
</html>
