<!doctype html>
<html lang="ro" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <meta name="description" content="Creeaza sau editeaza o activitate in comunitatea JoinUs.">
        <meta name="author" content="">

        <title th:text="${formTitle != null ? formTitle + ' - JoinUs' : 'Creare activitate - JoinUs'}">Creare activitate - JoinUs</title>

        <!-- CSS FILES -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,700;1,400&display=swap" rel="stylesheet">
        <link href="/css/bootstrap.min.css" rel="stylesheet">
        <link href="/css/bootstrap-icons.css" rel="stylesheet">
        <link href="/css/styles.css" rel="stylesheet">
    </head>

    <body class="page-auth page-create-activity">
        <main>
            <header th:replace="~{fragments/navbar :: navbar}"></header>

            <section class="auth-section section-padding">
                <div class="container">
                    <div class="row justify-content-center">
                        <div class="col-lg-11 col-xl-10 text-center">
                            <h3 class="mb-3" th:text="${formTitle != null ? formTitle : 'Formular activitate'}">Formular activitate</h3>
                            <p class="auth-subtitle" th:text="${formSubtitle != null ? formSubtitle : 'Completeaza detaliile si alege o imagine.'}">Completeaza detaliile si alege o imagine.</p>

                            <form class="custom-form auth-form activity-form-grid" th:attr="action=${formAction != null ? formAction : '/activities'}" th:object="${activityForm}" method="post" role="form" enctype="multipart/form-data">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

                                <div class="activity-card activity-card-left">
                                    <div class="activity-alert" th:if="${#fields.hasErrors('*')}">
                                        <div class="alert alert-danger mb-0">
                                            Completează toate câmpurile obligatorii corect.
                                        </div>
                                    </div>
                                    <div class="activity-card-header">
                                        <h4>Obligatoriu</h4>
                                        <p>Completează datele esențiale pentru activitate.</p>
                                    </div>
                                    <input type="text" th:field="*{title}" class="form-control" placeholder="Titlu activitate" required>
                                    <textarea th:field="*{description}" class="form-control" rows="3" placeholder="Descriere scurtă" required></textarea>

                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <input type="date" id="date" name="date" class="form-control"
                                                   th:value="${activityForm.date != null ? #temporals.format(activityForm.date, 'yyyy-MM-dd') : ''}"
                                                   th:min="${(editMode != null and editMode) ? null : #temporals.format(#temporals.createNow(), 'yyyy-MM-dd')}" required>
                                        </div>
                                        <div class="col-md-6">
                                            <input type="time" id="time" name="time" class="form-control"
                                                   th:value="${activityForm.time != null ? #temporals.format(activityForm.time, 'HH:mm') : ''}" required>
                                        </div>
                                    </div>

                                    <input type="text" th:field="*{location}" class="form-control" placeholder="Locație (oraș/raion/sat)" required>
                                    <input type="text" th:field="*{address}" class="form-control" placeholder="Adresă completă" required>

                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <input type="number" th:field="*{capacity}" class="form-control" min="1" max="200" placeholder="Număr persoane" required>
                                        </div>
                                        <div class="col-md-6">
                                            <select th:field="*{category}" class="form-control">
                                                <option value="Comunitate">Comunitate</option>
                                                <option value="Sport">Sport</option>
                                                <option value="Wellness">Wellness</option>
                                                <option value="Outdoor">Outdoor</option>
                                                <option value="Cultura">Cultura</option>
                                                <option value="Social">Social</option>
                                                <option value="Educatie">Educatie</option>
                                                <option value="Tech">Tech</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="activity-card activity-card-right">
                                    <div class="activity-card-header">
                                        <h4>Opțional</h4>
                                        <p>Adaugă o imagine și taguri pentru vizibilitate.</p>
                                    </div>
                                    <div>
                                        <label class="form-label">Încarcă o imagine</label>
                                        <input type="file" id="cloudinaryFile" name="imageFile" accept="image/*" class="form-control">
                                        <input type="hidden" th:field="*{imageUrl}" id="cloudinaryUrl">
                                        <div class="small text-muted mt-2" id="cloudinaryStatus">Imaginea se va încărca direct în Cloudinary.</div>
                                        <div class="mt-2" id="cloudinaryExistingWrap"
                                             th:if="${activityForm.imageUrl != null and !#strings.isEmpty(activityForm.imageUrl)}">
                                            <div class="small text-muted mb-1">Imagine curenta</div>
                                            <img th:src="${activityForm.imageUrl}" alt="Imagine curenta activitate"
                                                 style="width: 140px; height: 90px; object-fit: cover; border-radius: 10px; border: 1px solid rgba(31, 42, 68, 0.16);">
                                        </div>
                                        <div class="small text-danger mt-2" th:if="${imageError}" th:text="${imageError}"></div>
                                    </div>

                                    <div class="mt-3">
                                        <label class="form-label">Sau alege o imagine rapidă</label>
                                        <div class="row g-2">
                                            <div class="col-6" th:each="img : ${imageOptions}">
                                                <label class="d-flex align-items-center gap-2 p-2 border rounded-3 w-100">
                                                    <input class="form-check-input" type="radio" th:field="*{imageChoice}" th:value="${img}">
                                                    <img th:src="${img}" alt="Imagine activitate" class="rounded" style="width: 56px; height: 56px; object-fit: cover;">
                                                    <span class="small">Alege</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mt-3">
                                        <label class="form-label">Taguri (optionale, max 3)</label>
                                        <div class="tag-input" id="tagInput" data-max="3">
                                            <input type="text" id="tagText" class="form-control tag-input-field" list="tagOptions" placeholder="Scrie si apasa Enter">
                                            <input type="hidden" th:field="*{tags}" id="tagValues">
                                        </div>
                                        <datalist id="tagOptions">
                                            <option value="Alergare"></option>
                                            <option value="Relaxare"></option>
                                            <option value="Fotbal"></option>
                                            <option value="Echipa"></option>
                                            <option value="Drumetie"></option>
                                            <option value="Cultura"></option>
                                            <option value="Social"></option>
                                            <option value="Comunitate"></option>
                                        </datalist>
                                    </div>
                                </div>

                                <div class="activity-form-actions">
                                    <button type="submit" class="form-control" id="submitActivity" th:text="${submitLabel != null ? submitLabel : 'Creeaza activitate'}">Creeaza activitate</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer th:replace="~{fragments/footer :: footer}"></footer>

        <!-- JAVASCRIPT FILES -->
        <script src="/js/jquery.min.js"></script>
        <script src="/js/bootstrap.bundle.min.js"></script>
        <script src="/js/jquery.sticky.js"></script>
        <script src="/js/custom.js"></script>
        <script th:inline="javascript">
            (function () {
                const tagInput = document.getElementById('tagInput');
                if (!tagInput) {
                    return;
                }
                const maxTags = Number(tagInput.dataset.max || 3);
                const input = document.getElementById('tagText');
                const hidden = document.getElementById('tagValues');

                const tags = new Set();

                const render = () => {
                    tagInput.querySelectorAll('.tag-pill').forEach((pill) => pill.remove());
                    let index = 0;
                    tags.forEach((value) => {
                        const pill = document.createElement('span');
                        pill.className = 'tag-pill';
                        pill.textContent = value;

                        const remove = document.createElement('button');
                        remove.type = 'button';
                        remove.className = 'tag-remove';
                        remove.setAttribute('aria-label', 'Sterge tag');
                        remove.textContent = '×';
                        remove.addEventListener('click', () => {
                            tags.delete(value);
                            render();
                        });

                        pill.appendChild(remove);
                        tagInput.insertBefore(pill, input);
                        index += 1;
                    });
                    hidden.value = Array.from(tags).join(', ');
                };

                const addTag = (value) => {
                    const cleaned = value.trim();
                    if (!cleaned || tags.has(cleaned) || tags.size >= maxTags) {
                        return;
                    }
                    tags.add(cleaned);
                    render();
                };

                const initialTags = (hidden.value || '')
                    .split(',')
                    .map((part) => part.trim())
                    .filter((part) => part.length > 0);
                initialTags.forEach((tag) => addTag(tag));

                input.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' || event.key === ',' || event.key === ' ') {
                        event.preventDefault();
                        addTag(input.value);
                        input.value = '';
                    }
                });

                input.addEventListener('blur', () => {
                    if (input.value.trim()) {
                        addTag(input.value);
                        input.value = '';
                    }
                });
            })();
        </script>
        <script th:inline="javascript">
            (function () {
                const cloudName = /*[[${cloudinaryCloudName}]]*/ "";
                const uploadPreset = /*[[${cloudinaryUploadPreset}]]*/ "";
                const fileInput = document.getElementById('cloudinaryFile');
                const urlInput = document.getElementById('cloudinaryUrl');
                const statusEl = document.getElementById('cloudinaryStatus');
                const existingWrap = document.getElementById('cloudinaryExistingWrap');
                const imageChoiceRadios = document.querySelectorAll('input[type="radio"][name="imageChoice"]');
                const form = document.querySelector('form.auth-form');
                const submitBtn = document.getElementById('submitActivity');
                let isUploading = false;
                const canClientUpload = Boolean(cloudName && uploadPreset);

                if (!fileInput) {
                    return;
                }

                const updateStatus = (text, isError) => {
                    statusEl.textContent = text;
                    statusEl.style.color = isError ? '#c0392b' : '#6c757d';
                };

                fileInput.addEventListener('change', async () => {
                    const file = fileInput.files && fileInput.files[0];
                    if (!file) {
                        return;
                    }

                    if (urlInput) {
                        urlInput.value = '';
                    }
                    imageChoiceRadios.forEach((radio) => {
                        radio.checked = false;
                    });
                    if (existingWrap) {
                        existingWrap.style.display = 'none';
                    }

                    if (!canClientUpload) {
                        updateStatus('Imagine selectată. Se va încărca la trimitere.', false);
                        return;
                    }

                    isUploading = true;
                    if (submitBtn) {
                        submitBtn.disabled = true;
                    }
                    updateStatus('Se încarcă imaginea...', false);
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('upload_preset', uploadPreset);

                    try {
                        const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
                            method: 'POST',
                            body: formData
                        });
                        if (!response.ok) {
                            throw new Error('Upload failed');
                        }
                        const data = await response.json();
                        if (!data.secure_url) {
                            throw new Error('Missing URL');
                        }
                        urlInput.value = data.secure_url;
                        fileInput.value = '';
                        updateStatus('Imagine încărcată cu succes.', false);
                    } catch (error) {
                        urlInput.value = '';
                        updateStatus('Upload eșuat. Încearcă din nou.', true);
                    } finally {
                        isUploading = false;
                        if (submitBtn) {
                            submitBtn.disabled = false;
                        }
                    }
                });

                if (!canClientUpload) {
                    updateStatus('Imaginea se va încărca la trimitere.', false);
                }

                if (form) {
                    form.addEventListener('submit', (event) => {
                        if (isUploading) {
                            event.preventDefault();
                            updateStatus('Așteaptă finalizarea upload-ului.', true);
                            return;
                        }
                        if (canClientUpload && urlInput && urlInput.value && fileInput) {
                            fileInput.value = '';
                        }
                        const hasFile = fileInput.files && fileInput.files.length > 0;
                        if (canClientUpload && hasFile && (!urlInput.value || urlInput.value.trim() === '')) {
                            event.preventDefault();
                            updateStatus('Imaginea nu s-a încărcat încă. Reîncearcă.', true);
                        }
                    });
                }

                imageChoiceRadios.forEach((radio) => {
                    radio.addEventListener('change', () => {
                        if (radio.checked && urlInput) {
                            urlInput.value = '';
                        }
                        if (existingWrap) {
                            existingWrap.style.display = 'none';
                        }
                    });
                });
            })();
        </script>
    </body>
</html>
